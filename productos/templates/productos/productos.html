{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos</title>
    <link rel="stylesheet" href="{% static 'css/product-style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        .admin-clickable:hover {
            cursor: pointer;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    {% include 'core/header.html' %}
    <div class="container mt-4">

        <h3>Filtrar por Categoría:</h3>
        <div id="categorias-container" class="mb-3">
            <button class="btn btn-primary" data-id="all">Todos</button>
            </div>

        <div class="row" id="productos-container">
            </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {{ user.is_staff|json_script:"user_is_admin" }}
    <script>
        const USER_IS_ADMIN = JSON.parse(document.getElementById('user_is_admin').textContent);
        const PLACEHOLDER_IMG_URL = "{% static 'img/placeholder.jpg' %}";
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const categoriasContainer = document.getElementById('categorias-container');
            const productosContainer = document.getElementById('productos-container');

            async function cargarCategorias() {
                try {
                    const response = await fetch('/productos/api-categorias/');
                    const categorias = await response.json();
                    
                    categorias.forEach(cat => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-secondary';
                        button.textContent = cat.nombre;
                        button.dataset.id = cat.id;
                        categoriasContainer.appendChild(button);
                    });
                } catch (error) {
                    console.error("Error cargando categorías:", error);
                }
            }

            async function cargarProductos(categoriaId) {
                let url = '/productos/api-crud/';
                if (categoriaId && categoriaId !== 'all') {
                    url = `/productos/api-crud/?categoria=${categoriaId}`;
                }

                try {
                    const response = await fetch(url, { cache: 'no-store' });
                    const productos = await response.json();
                    
                    productosContainer.innerHTML = ''; 
                    
                    productos.forEach(prod => {
                        const imgSrc = prod.imagen ? prod.imagen : PLACEHOLDER_IMG_URL;
                        let productoHTML = '';
                        
                        let cardClasses = "card h-100";
                        let cardDataId = "";

                        if (USER_IS_ADMIN) {
                            cardClasses += " admin-clickable";
                            cardDataId = `data-id="${prod.id}"`;
                        }
                        
                        if (!prod.disponible) {
                            cardClasses += " text-bg-light";
                        }

                        productoHTML = `
                        <div class="col-md-6 mb-3">
                            <div class="${cardClasses}" ${cardDataId} style="${prod.disponible ? '' : 'opacity: 0.6;'}">
                                <div class="row g-0">
                                    <div class="col-md-4">
                                        <img src="${imgSrc}" class="img-fluid rounded-start" alt="${prod.nombre}">
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card-body">
                                            <h5 class="card-title">${prod.nombre}</h5>
                                            <p class="card-text">${prod.descripcion || ''}</p>
                                            <p class="card-text"><small class="text-body-secondary">Precio $${prod.precio}</small></p>
                                            <p class="card-text text-danger fw-bold">${prod.disponible ? '' : 'PRODUCTO AGOTADO'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                        productosContainer.innerHTML += productoHTML;
                    });
                } catch (error) {
                    console.error("Error cargando productos:", error);
                }
            }

            categoriasContainer.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') {
                    const categoriaId = e.target.dataset.id;
                    cargarProductos(categoriaId);
                }
            });

            productosContainer.addEventListener('click', function(e) {
                if (!USER_IS_ADMIN) return; 
                
                const card = e.target.closest('.admin-clickable');
                if (card) {
                    const productoId = card.dataset.id;
                    window.location.href = `/productos/editar/${productoId}/`;
                }
            });

            cargarCategorias();
            cargarProductos('all');
        });
    </script>

    {% include 'core/footer.html' %}
</body>
</html>