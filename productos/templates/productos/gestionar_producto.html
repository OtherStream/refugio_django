{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if producto %}Editar Producto{% else %}Agregar Producto{% endif %}</title>
    <link rel="stylesheet" href="{% static 'css/formularios.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    {% include "core/header.html" %}
    
    <form class="formulario" id="producto-form" enctype="multipart/form-data">
        <h2 id="form-titulo">{% if producto %}Editar Producto{% else %}Agregar Producto{% endif %}</h2>
        
        {% csrf_token %}
        
        <div id="form-general-errors" class="alert alert-danger" style="display: none;"></div>

        <div class="mb-3">
            <label for="id_nombre" class="form-label">Nombre:</label>
            <input type="text" id="id_nombre" name="nombre" class="form-control" required>
            <span id="error-nombre" class="text-danger small"></span>
        </div>
        
        <div class="mb-3">
            <label for="id_categoria" class="form-label">Categoría:</label>
            <select id="id_categoria" name="categoria" class="form-control">
                <option value="">Cargando categorías...</option>
            </select>
            <span id="error-categoria" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label for="id_descripcion" class="form-label">Descripción:</label>
            <textarea id="id_descripcion" name="descripcion" class="form-control"></textarea>
            <span id="error-descripcion" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label for="id_precio" class="form-label">Precio:</label>
            <input type="number" step="0.01" id="id_precio" name="precio" class="form-control" required>
            <span id="error-precio" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label for="id_imagen" class="form-label">Imagen:</label>
            <div id="imagen-actual-container" class="mb-2" style="display: none;">
                <p>Imagen actual:</p>
                <img id="imagen-actual" src="" alt="Imagen actual" style="max-width: 100px; max-height: 100px;">
            </div>
            <input type="file" id="id_imagen" name="imagen" class="form-control" accept="image/*">
            <span id="error-imagen" class="text-danger small"></span>
        </div>

        <div class="mb-3 form-check">
            <input type="checkbox" id="id_disponible" name="disponible" class="form-check-input" checked>
            <label for="id_disponible" class="form-check-label">Disponible</label>
            <span id="error-disponible" class="text-danger small"></span>
        </div>

        <button type="submit" id="boton-guardar" class="btn btn-primary w-100">
            {% if producto %}Guardar Cambios{% else %}Guardar Producto{% endif %}
        </button>
        <div class="formulario" style="padding-top: 0;">
        <button type="button" id="boton-eliminar" class="btn btn-danger w-100 mt-2">
            Eliminar Producto
        </button>
    </div>
    </form>
    
    {% if producto %}
    
    {% endif %}

    {% include "core/footer.html" %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {{ producto.pk|default:None|json_script:"producto-id" }}
    
    <script>
        const PRODUCTO_ID = JSON.parse(document.getElementById('producto-id').textContent);
        
        const IS_EDITING = PRODUCTO_ID !== null;
        const API_URL_PRODUCTOS = IS_EDITING ? `/productos/api-crud/${PRODUCTO_ID}/` : '/productos/api-crud/';
        const API_URL_CATEGORIAS = '/productos/api-categorias/';
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const form = document.getElementById('producto-form');
        const botonGuardar = document.getElementById('boton-guardar');
        const botonEliminar = document.getElementById('boton-eliminar');
        const generalErrorsDiv = document.getElementById('form-general-errors');
        
        // --- Función para Cargar Categorías (GET a API) ---
        async function cargarCategorias(selectedId = null) {
            const select = document.getElementById('id_categoria');
            try {
                const response = await fetch(API_URL_CATEGORIAS);
                const categorias = await response.json();
                
                select.innerHTML = '<option value="">Selecciona una categoría</option>'; 
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nombre;
                    if (cat.id === selectedId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error cargando categorías:", error);
                select.innerHTML = '<option value="">Error al cargar</option>';
            }
        }

        // --- Función para Cargar Datos del Producto (GET a API) ---
        async function cargarDatosProducto() {
            if (!IS_EDITING) {
                await cargarCategorias(); // Solo cargar categorías para un formulario nuevo
                return;
            }
            
            try {
                // LLAMADA GET A LA API
                const response = await fetch(API_URL_PRODUCTOS);
                const data = await response.json();//regresa objeto completo
                
                document.getElementById('id_nombre').value = data.nombre || '';
                document.getElementById('id_descripcion').value = data.descripcion || '';
                document.getElementById('id_precio').value = data.precio || '';
                document.getElementById('id_disponible').checked = data.disponible;
                
                await cargarCategorias(data.categoria); 

                if (data.imagen) {
                    document.getElementById('imagen-actual').src = data.imagen;
                    document.getElementById('imagen-actual-container').style.display = 'block';
                }
                
            } catch (error) {
                console.error("Error cargando datos del producto:", error);
                generalErrorsDiv.textContent = 'Error al cargar los datos del producto.';
                generalErrorsDiv.style.display = 'block';
            }
        }

        function mostrarErrores(errors) {
            document.querySelectorAll('.text-danger.small').forEach(span => span.textContent = '');
            generalErrorsDiv.style.display = 'none';
            generalErrorsDiv.innerHTML = '';

            for (const [field, messages] of Object.entries(errors)) {
                const errorSpan = document.getElementById(`error-${field}`);
                if (errorSpan) {
                    errorSpan.textContent = messages.join(' ');
                } else {
                    generalErrorsDiv.innerHTML += `<p>${field}: ${messages.join(' ')}</p>`;
                    generalErrorsDiv.style.display = 'block';
                }
            }
        }

        // --- Event Listener para GUARDAR (POST / PATCH con API) ---
        form.addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            botonGuardar.disabled = true;
            botonGuardar.textContent = 'Guardando...';

            const formData = new FormData(form);
            
            if (!formData.has('disponible')) {
                formData.set('disponible', false);
            }
            
            const imagenInput = document.getElementById('id_imagen');
            if (IS_EDITING && imagenInput.files.length === 0) {
                formData.delete('imagen');
            }

            try {
                const response = await fetch(API_URL_PRODUCTOS, {
                    method: IS_EDITING ? 'PATCH' : 'POST', 
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    body: formData
                });

                const data = await response.json();//Recibes el objeto completo (actualizado)

                if (response.ok) {
                    alert('¡Producto guardado con éxito!');
                    window.location.href = "{% url 'productos' %}";
                } else {
                    mostrarErrores(data);
                }

            } catch (error) {
                console.error("Error al guardar:", error);
                mostrarErrores({ 'general': ['Error de conexión. Inténtalo de nuevo.'] });
            } finally {
                botonGuardar.disabled = false;
                botonGuardar.textContent = IS_EDITING ? 'Guardar Cambios' : 'Guardar Producto';
            }
        });

        // --- ELIMINAR (DELETE a API) ---
        if (IS_EDITING && botonEliminar) {
            botonEliminar.addEventListener('click', async function() {
                if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                    try {
                        const response = await fetch(API_URL_PRODUCTOS, {
                            method: 'DELETE',
                            headers: { 'X-CSRFToken': csrftoken }
                        });

                        if (response.ok) {
                            alert('¡Producto eliminado con éxito!');
                            window.location.href = "{% url 'productos' %}";
                        } else {
                            const data = await response.json();
                            mostrarErrores(data || { 'general': ['Error al eliminar.'] });
                        }
                    } catch (error) {
                        console.error('Error en fetch DELETE:', error);
                        mostrarErrores({ 'general': ['Error de conexión.'] });
                    }
                }
            });
        }

        cargarDatosProducto();
    </script>
</body>
</html>